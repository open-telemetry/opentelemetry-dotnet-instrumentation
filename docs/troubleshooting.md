# Troubleshooting

Check if you are not hitting one of the issues listed below.

## Handling of Assembly version Conflicts

OpenTelemetry SDK NuGet package are deployed with the OpenTelemetry .NET Instrumentation.
Conflicts in assemblies referenced by "source instrumentations", should be handled in
the same way: updating the project references to ensure that they are the same version
as the one used by the instrumentation.

However, the workarounds proposed above only work at build time. When a rebuild is not
possible, there are ways to force the application to use the assembly versions shipped
together with the instrumentation.

For .NET Framework applications, the workaround is to use Binding Redirects. For .NET Core
[Framework-dependent deployment](https://docs.microsoft.com/en-us/dotnet/core/deploying/deploy-with-vs?tabs=vs156#framework-dependent-deployment)
applications,
[Additional-deps](https://github.com/dotnet/runtime/blob/main/docs/design/features/additional-deps.md)
and [runtime package store](https://docs.microsoft.com/en-us/dotnet/core/deploying/runtime-store)
from OpenTelemetry .NET Auto-Instrumentation installation location can be used as workaround.
For other .NET Core deployment models, the workaround is to manipulate the `deps.json`. Currently,
we do not automate any of these workarounds, but we are manually validating them.

### .NET Framework Binding Redirects

The [samples/BindingRedirect](./../samples/BindingRedirect/) app shows how
to use the `app.config` to solve the version conflicts. As configured in the PoC branch,
the BindingRedirect sample can only run successfully under the instrumentation since the
binding redirect makes the application dependent on a version of `System.Diagnostics.DiagnosticSource`
that is not available during building time.

### .NET Core Dependency File

To fix assembly version conflicts in .NET Core, the `<application>.deps.json`, generated by default
during the build of .NET Core applications, needs to be modified. Build a .NET Core app with package
references using the required version and use the respective `deps.json` file to see what changes
are needed.

To experiment with modifying the `deps.json` file, add a reference to the required version OpenTelemetry
package to the [samples/CoreAppOldReference](./../samples/CoreAppOldReference/) sample and rebuild the
application. Save the generated `deps.json` file, remove the package reference and rebuild the
sample app. Compare the files to understand the changes.

## No proper relationship between spans

On .NET Framework strong name signing can force multiple versions
of the same assembly being loaded on the same process.
This causes a separate hierarchy of Activity objects.
If you are referencing packages in your application that use
different version of the `System.Diagnostics.DiagnosticSource`
than the `OpenTelemetry.Api` used by
OpenTelemetry .NET Auto-Instrumentation (`6.0.0`)
you have to explicitly reference
the `System.Diagnostics.DiagnosticSource` package in the correct version
in your application.
This will cause automatic binding redirection to occur resolving the issue.

If automatic binding redirection is [disabled](https://docs.microsoft.com/en-us/dotnet/framework/configure-apps/how-to-enable-and-disable-automatic-binding-redirection)
you can also manually add binding redirection to [the `App.config` file](../samples/BindingRedirect/App.config).

## High CPU usage

Check if you have not enabled the auto-instrumentation globally
by setting theenvironment variables on system or user level.

If it was really intended, `OTEL_DOTNET_AUTO_EXCLUDE_PROCESSES` and `OTEL_DOTNET_AUTO_INCLUDE_PROCESSES`
to include/exclude applications from the tracing auto-instrumentation.

## Investigating other issues

If none of the suggestions above solves your issue, detailed logs are necessary.
Follow the steps below to get the detailed logs from
OpenTelemetry AutoInstrumentation for .NET
and make sure to add them when creating a GitHub issue.

Set the environment variable `OTEL_DOTNET_AUTO_DEBUG` to `true`
before the instrumented process starts.
By default, the library writes the log files under the below predefined locations.
If needed, change the default location by updating
the environment variable `OTEL_DOTNET_AUTO_LOG_DIRECTORY` to an appropriate path.
After obtaining the logs, remember to remove the environment variable
`OTEL_DOTNET_AUTO_DEBUG` to avoid unnecessary overhead.
