# AGENTS: OpenTelemetry.AutoInstrumentation.Native.Tests

## Quick facts
- Purpose: Google Test harness validating helper types that support the native profiler (`src/OpenTelemetry.AutoInstrumentation.Native`).
- Language/toolchain: C++17; MSBuild/CL with the v143 toolset. The project lives in `OpenTelemetry.AutoInstrumentation.Native.Tests.vcxproj`.
- Invocation: `dotnet nuke RunNativeTests` builds `CompileNativeSrc` dependencies, restores Google Test, and executes the binaries (Windows only today).
- Test assets: loads `TestApplication.ExampleLibrary.dll` and tracer companion assemblies produced under `test/test-applications/integrations`.
- Formatter: reuses the native formatter (`./scripts/format-native.sh`) when updating test sources.

## Suite breakdown
- `assembly_version_redirection_test.cpp`: regression checks for `AssemblyVersionRedirection::CompareToAssemblyVersion`.
- `clr_helper_test.cpp`: enumerates types, methods, and assembly references via `EnumTypeDefs`, `EnumTypeRefs`, and `GetTypeInfo` using real metadata from `TestApplication.ExampleLibrary.dll`.
- `metadata_builder_test.cpp`: spins up `MetadataBuilder` and `ModuleMetadata` instances and validates emitting tracer assembly references.
- `environment_variables_parser_test.cpp`: exercises boolean parsing helpers (`TrueCondition`, `FalseCondition`) fed by `string_utils`.
- `integration_test.cpp` / `version_struct_test.cpp`: parse integration manifests and version math helpers used by the instrumentation planner.
- `startup_hook_test.cpp`: asserts that the startup hook path detection logic tolerates different separators and multiple hooks.
- `thread_span_context_test.cpp`: covers the continuous profiler thread-span map operations (`Put`, `Get`, `Remove`).
- `util_test.cpp`: Windows-only coverage of `GetConfiguredSize` and environment variable fallbacks.
- `pch.cpp` / `pch.h`: standard precompiled-header pair to keep compilation times down.
- `test_helpers.h`: common fixture that bootstraps COM metadata interfaces; updates here must stay synchronized with the harness in `src/OpenTelemetry.AutoInstrumentation.Native`.

## Build & execution flow
1. `dotnet nuke RunNativeTests` restores the NuGet-provided Google Test package (`packages.config`) and builds the native profiler so headers/libs are present under `src/OpenTelemetry.AutoInstrumentation.Native/lib`.
2. The test project pulls in managed fixtures (`TestApplication.ExampleLibrary*.csproj`) to emit the sample assemblies that metadata-based tests load at runtime.
3. MSBuild emits the test binary under `test/OpenTelemetry.AutoInstrumentation.Native.Tests/bin/<Config>/<Platform>/`; Nuke then runs it with Google Test's default console runner.

## Dependencies & prerequisites
- Requires Windows with the Desktop CLR installed; several tests call into `ICLRMetaHost` and `IMetaDataImport2` and are excluded on non-Windows targets.
- Needs the tracer home layout under `bin/tracer-home/` generated by `CompileNativeSrc`; `startup_hook_test` inspects `OpenTelemetry.AutoInstrumentation.StartupHook.dll` directly.
- Google Test 1.8 ships through the `Microsoft.googletest.v140.windesktop.msvcstl.static.rt-static` package. When adding new tests, prefer the existing `TEST`, `TEST_F`, and `ASSERT_*` macros for consistency.
- Managed fixtures depend on .NET Framework 4.6.2; ensure the targeting pack is available locally when opening the solution in Visual Studio.

## Development tips
- Keep new helpers inside `test_helpers.h` when they interact with COM metadata so other suites can reuse the scaffolding.
- Avoid hardcoding absolute pathsâ€”derive from `__FILE__` (as `startup_hook_test.cpp` does) so the suite stays relocatable inside the repo.
- Seed new sample IL scenarios in `TestApplication.ExampleLibrary` projects; the native tests already reference their outputs.
- Guard Windows-specific behaviour with `#ifdef _WIN32` and provide cross-platform fallbacks when feasible so future Unix test runs can be enabled.

## Troubleshooting
- `TestApplication.ExampleLibrary.dll was not found`: ensure `dotnet restore` succeeded and the dependent C# projects build; running `dotnet nuke CompileManagedTestApps` (implicit in `RunNativeTests`) repopulates `bin/test-applications`.
- Linker errors about missing `fmt`/`spdlog`: rerun `dotnet nuke CompileNativeSrc` to refresh native deps in `src/OpenTelemetry.AutoInstrumentation.Native/lib`.
- Startup hook tests failing after layout changes: verify the tracer home copy step keeps the managed bootstrapper under `bin/tracer-home/net/`.
- Metadata APIs returning E_FAIL: check that Visual Studio Developer Command Prompt (or equivalent environment) is used so COM registration and CLR discovery succeed.

## Useful references
- `src/OpenTelemetry.AutoInstrumentation.Native/AGENTS.md` for the profiler architecture that these tests exercise.
- `docs/developing.md` for the full build/test matrix and CI entry points.
- `test/OpenTelemetry.AutoInstrumentation.Native.Tests/OpenTelemetry.AutoInstrumentation.Native.Tests.vcxproj` for project-wide include paths, NuGet packages, and build configuration knobs.
