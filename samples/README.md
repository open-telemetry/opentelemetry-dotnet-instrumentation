# Instrumenting Sample Applications with the OpenTelemetry .NET Auto-Instrumentation

The following samples show how different instrumentation scenarios are covered by
the OpenTelemetry .NET Auto-Instrumentation.

## Overview

The sample script instruments two .NET processes. These processes are identified
as [OpenTelemetry services](https://github.com/open-telemetry/opentelemetry-specification/blob/d6bcc0cb072d8d6f6ced856f1f23c451648a3caa/specification/resource/semantic_conventions/README.md#service)
with the following names:

 1. **`aspnet-server`**: ASP.NET Core application that makes requests to MongoDB and Redis databases.
 2. **`http-client`**: .NET application that makes a few HTTP requests to the `aspnet-server` and some public websites.

The script creates Docker containers for MongoDB, Redis, and Jaeger.
You can see the traces generated by the sample in the Jaeger container.
The number and organization of traces generated depends on the `http-client`
used in the specific run. The script waits for your input before stopping the containers.

## How to Run the Samples

 1. Create a local build of the project following the [developing instructions](../docs/developing.md).
 2. At the root of the repository, run the `./run_sample.sh` script.

The script run can be customized using the following environment variables:

| Environment variable | Description | Default |
|-|-|-|
| **aspNetAppTargetFramework** | Target framework for the `aspnet-server` service | `netcoreapp3.1` |
| **configuration** | Build configuration for sample apps, either `Release` or `Debug` | `Release` |
| **enableProfiling** | Value of `CLR_ENABLE_PROFILING` and `CORECLR_ENABLE_PROFILING` for the sample apps | `1` |
| **exporter** | Value for [`OTEL_TRACES_EXPORTER`](../docs/config.md#exporters) env. variable | `otlp` |
| **keepContainers** | Whether the docker containers should kept after the script finishes | `false` |
| **sampleApp** | Application selected for the `http-client` service | `ConsoleApp` |
| **sampleAppInjectSDK** | Whether auto-instrumentation injects the SDK on the `http-client` service | `true` |
| **sampleAppTargetFramework** | Target framework for the `http-client` service | `netcoreapp3.1` |
| **skipAppBuild** | Whether the script should skip building the sample apps | `false` |

Usage example:

```bash
sampleAppTargetFramework="net6.0" ./run-sample.sh
```

## Sample Projects

You can find a description of each sample project below.

### BindingRedirect Project

Sample client app that uses .NET Framework binding redirects to handle assembly version conflict
between auto-instrumentation and third-party libraries that cannot be updated to the same version required by OpenTelemetry. See the `OldReference` project for more information.

The project representing the third-party library has a legacy Activity named `InstrumentedHttpCall.GetAsync`
set [`OTEL_DOTNET_AUTO_LEGACY_SOURCES`](../docs/config.md#customization) to capture it.

The following usage example is for Windows, as binding redirection only applies to .NET Framework:
```bash
OTEL_DOTNET_AUTO_LEGACY_SOURCES="InstrumentedHttpCall.GetAsync" sampleApp=BindingRedirect sampleAppTargetFramework=net472 ./run-sample.sh
```

### ConsoleApp

The default sample app used by `./run-samples.sh`. It contains manual instrumentation using an
[ActivitySource](https://github.com/open-telemetry/opentelemetry-dotnet/blob/main/src/OpenTelemetry/README.md#activity-source)
and [OpenTracing](https://github.com/open-telemetry/opentelemetry-dotnet/tree/main/src/OpenTelemetry.Shims.OpenTracing#readme).
No configuration is needed to capture the manually created ActivitySource, as its name is
`OpenTelemetry.AutoInstrumentation.ConsoleApp`, which is match for the default value for the environment variable
[`OTEL_DOTNET_AUTO_ADDITIONAL_SOURCES`](../docs/config.md#customization).

Usage example:
```bash
sampleAppTargetFramework="net6.0" ./run-sample.sh
```

### ConsoleApp.SelfBootstrap

A sample client app that takes care of bootstrapping the OpenTelemetry SDK. It uses an
[ActivitySource](https://github.com/open-telemetry/opentelemetry-dotnet/blob/main/src/OpenTelemetry/README.md#activity-source)
to implement manual instrumentation. The bootstrap code takes care of adding the ActivitySource name
for the auto-instrumentation and the manual instrumentation.

The bootstrap code sets the [Zipkin exporter](https://github.com/open-telemetry/opentelemetry-dotnet/blob/main/src/OpenTelemetry.Exporter.Zipkin/README.md)
provided by the SDK. The Jaeger container is also configured to accept Zipkin spans.

Use the script environment variable `sampleAppInjectSDK` to control the value of
[`OTEL_DOTNET_AUTO_LOAD_AT_STARTUP`](../docs/config.md#customization) used to launch
the sample app.

Usage example:
```bash
sampleAppInjectSDK=false sampleApp=ConsoleApp.SelfBootstrap ./run-sample.sh
```

### CoreAppOldReference

Sample client app that uses NuGet package version resolution at build time to handle assembly version conflict
between auto-instrumentation and third-party libraries that can't be updated to the same version required by OpenTelemetry. See the `OldReference` project for more information.

The project representing the third-party library has a legacy Activity named `InstrumentedHttpCall.GetAsync`
set [`OTEL_DOTNET_AUTO_LEGACY_SOURCES`](../docs/config.md#customization) to capture it.

Usage example:
```bash
OTEL_DOTNET_AUTO_LEGACY_SOURCES="InstrumentedHttpCall.GetAsync" sampleApp=CoreAppOldReference ./run-sample.sh
```

### OldReference

Represents a third-party project that can't be updated to use the same version of the assemblies
required by OpenTelemetry .NET SDK used by auto-instrumentation.

### OpenTracing.Library

A library that wraps an OpenTracing span around a `Func<Task>` delegate.

### Samples.AspNetCoreMvc31

An ASP.NET Core MVC application used to simulate a server application capable of making calls
to MongoDB and Redis. In addition to these calls it also supports various other endpoints. Check
the [Controllers](./Samples.AspNetCoreMvc31/Controllers/) for some of the endpoints that
can be used.

Usage example:
```bash
aspNetAppTargetFramework="net6.0" ./run-sample.sh
```

### Vendor.Distro

Implements an [instrumentation plugin](../docs/config.md#customization).
The sample script adds this plugin to the instrumentation configuration
when launching the server application of the demo.
